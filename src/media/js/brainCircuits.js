var node_link_map,link_map,paper_map,node_map,node_neighbor_map,link_rating_map,record_rating_map,active_data_nodes,active_data_links,svg,arcs,linkGenerator,links,vis_width=800,vis_height=800,inner_radius=0.3*Math.min(vis_width,vis_height),outer_radius=1.5*inner_radius,directionType={"in":1,out:2,bi:3},mutex=2;d3.json("media/data/test_node.json",function(a){node_map={};for(var b=a.length,d=0;d<b;++d)node_map[a[d].key]=a[d];mutex-=1});
d3.json("media/data/test_link.json",function(a){link_map={};node_link_map={};for(var b=a.length,d=0;d<b;++d){var c=a[d],c={key:c.key,source:node_map[c.sourceKey],target:node_map[c.targetKey]};link_map[c.key]=c;node_link_map[c.source.key+"-"+c.target.key]=c}mutex-=1});waitForDataLoading();
function renderCanvas(){active_data_nodes=[];for(var a in node_map){var b=node_map[a];1===b.depth&&active_data_nodes.push(b)}computeArcParameters(active_data_nodes);active_data_links=[];for(a in link_map)b=link_map[a],1===b.source.depth&&1===b.target.depth&&active_data_links.push(b);arcs=d3.svg.arc().innerRadius(inner_radius).outerRadius(outer_radius);svg=d3.select("#canvas").append("svg").attr("width","100%").attr("height","100%").append("g").attr("transform","translate("+2*vis_width/3+","+vis_height/
2+")").append("g");enterNodes();enterLinks()}function waitForDataLoading(){0<mutex?setTimeout(function(){waitForDataLoading()},1E3):renderCanvas()};function expandRegion(a){var b=a.children,d=b.length;if(!(1>d)){for(var c=a.startAngle,n=(a.endAngle-c)/d,k=[],l=[],i=[],m=active_data_links.length,f=0;f<m;++f){var g=active_data_links[f];g.source===a&&(l.push(g.target),i.push(g.source.key+"-"+g.target.key));g.target===a&&(k.push(g.source),i.push(g.source.key+"-"+g.target.key))}for(var g=k.length,p=l.length,m=i.length,f=0;f<d;++f){var j=node_map[b[f]];calculateArcPositions(j,c,n,f);active_data_nodes.push(j);for(var h=0;h<g;++h){var e=k[h],e=e.key+
"-"+j.key,e=node_link_map[e];void 0!==e&&active_data_links.push(e)}for(h=0;h<p;++h)e=l[h],e=j.key+"-"+e.key,e=node_link_map[e],void 0!==e&&active_data_links.push(e)}enterNodes();enterLinks();a=$.inArray(a,active_data_nodes);active_data_nodes.splice(a,1);for(f=0;f<m;++f)e=i[f],e=node_link_map[e],console.log(e),a=$.inArray(e,active_data_links),console.log(a),active_data_links.splice(a,1);svg.selectAll("path").data(active_data_nodes,function(a){return a.key}).exit().remove();svg.selectAll("text").data(active_data_nodes,
function(a){return a.key}).exit().remove();svg.selectAll("line").data(active_data_links,function(a){return a.key}).exit().remove();console.log(active_data_links)}}function linkClick(a){console.log(a.source);console.log(a.target)}
function enterNodes(){svg.selectAll("arcs").data(active_data_nodes,function(a){return a.key}).enter().append("path").style("fill","white").style("stroke","gray").attr("d",arcs).on("click",expandRegion);svg.selectAll("text").data(active_data_nodes,function(a){return a.key}).enter().append("text").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("class","text visible").text(function(a){return a.name})}
function enterLinks(){svg.selectAll("links").data(active_data_links,function(a){return a.key}).enter().append("svg:line").attr("stroke","black").attr("fill","none").attr("x1",function(a){return a.source.x}).attr("x2",function(a){return a.target.x}).attr("y1",function(a){return a.source.y}).attr("y2",function(a){return a.target.y}).on("click",linkClick)}function computeArcParameters(a){for(var b=a.length,d=2*Math.PI/b,c=0;c<b;++c)calculateArcPositions(a[c],0,d,c)}
function calculateArcPositions(a,b,d,c){a.startAngle=b+d*c;a.endAngle=b+d*(c+1);b=d*(c+0.5)+b;d=inner_radius+(outer_radius-inner_radius)/2;a.x=d*Math.cos(Math.PI/2-b);a.y=-d*Math.sin(Math.PI/2-b)};function contains(a,b){for(var d=a.length,c=0;c<d;++c)if(b.key===a[c].key)return c;return-1}function generateKeyForNodeLinkMap(a,b){var d=Math.min(a.key,b.key),c=Math.max(a.key,b.key);return d+"-"+c};
