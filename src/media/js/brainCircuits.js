var node_link_map,link_map,paper_map,node_map,node_in_neighbor_map,node_out_neighbor_map,link_rating_map,record_rating_map,selected_source,selected_target,active_data_nodes,active_data_links,active_data_nodes_force,active_data_links_force,svg_circular,svg_force,arcs,curves,links,force,vis_width=800,vis_height=800,inner_radius=0.32*Math.min(vis_width,vis_height),outer_radius=1.2*inner_radius,directionType={"in":1,out:2,bi:3},mode={exploration:1,search:2,fixation:3},colorPalette=[d3.rgb(141,211,199).toString(),
d3.rgb(255,255,179).toString(),d3.rgb(190,186,218).toString(),d3.rgb(251,128,114).toString(),d3.rgb(128,177,211).toString(),d3.rgb(253,180,98).toString(),d3.rgb(179,222,105).toString(),d3.rgb(252,205,229).toString(),d3.rgb(217,217,217).toString(),d3.rgb(188,128,189).toString(),d3.rgb(204,235,197).toString(),d3.rgb(255,237,111).toString()],mutex=3,enable_piwik=!1,enable_owa=!1,current_mode=mode.exploration,max_hop=1;d3.json("media/data/test_node.json",function(a){node_map={};node_in_neighbor_map={};node_out_neighbor_map={};for(var c=a.length,b=0;b<c;++b){var d=a[b];d.circ={};node_map[d.key]=d;node_in_neighbor_map[d.key]=[];node_out_neighbor_map[d.key]=[]}for(var e in node_map){d=node_map[e];for(b=0;b<d.children.length;++b)a=node_map[d.children[b]],void 0!==a&&(a.parent=e)}mutex-=1});
d3.json("media/data/test_paper.json",function(a){paper_map={};for(var c=a.length,b=0;b<c;++b){var d=a[b];paper_map[d.key]=d}mutex-=1});
d3.json("media/data/test_link.json",function(a){link_map={};node_link_map={};var c=a.length;console.log(c);for(var b=0;b<c;++b){var d=a[b],e={key:d.key,source:node_map[d.sourceKey],target:node_map[d.targetKey],paper:d.paper,children:d.children,isDerived:d.isDerived};link_map[e.key]=e;node_link_map[e.source.key+"-"+e.target.key]=e;node_in_neighbor_map[d.targetKey].push(d.sourceKey);node_out_neighbor_map[d.sourceKey].push(d.targetKey)}console.log(link_map);mutex-=1});waitForDataLoading();
d3.select("#bt-search").on("click",searchButtonClick);d3.select("#bt-clear").on("click",clearButtonClick);d3.select("#maxHop").on("change",setMaxHop);$("#sourceSelect").change(sourceSearchInput);$("#targetSelect").change(targetSearchInput);
function renderCanvas(){assignColors();initActiveNodes();computeCircularNodesParameters(active_data_nodes);initActiveLinks();arcs=d3.svg.arc().innerRadius(inner_radius).outerRadius(outer_radius).startAngle(function(a){return a.circ.start_angle}).endAngle(function(a){return a.circ.end_angle});curves=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}).interpolate("basis");svg_circular=d3.select("#canvas-circular").append("svg").attr("width",vis_width).attr("height",vis_height).append("g").attr("transform",
"translate("+vis_width/2+","+vis_height/2+")").append("g");svg_force=d3.select("#canvas-force").append("svg").attr("width",vis_width).attr("height",vis_height).append("g");enterCircularNodes();enterCircularLinks();updateCircularTexts()}function setupUIElements(){appendNodesAsOptions(node_map);$(".chzn-select").chosen({allow_single_deselect:!0})}function waitForDataLoading(){0<mutex?setTimeout(function(){waitForDataLoading()},1E3):(renderCanvas(),setupUIElements())};function expandRegion(a,c){var b=c.length;if(!(1>b)){for(var d=a.circ.start_angle,e=(a.circ.end_angle-d)/b,f=[],l=[],h=active_data_links.length;h--;){var k=active_data_links[h];k.source===a?(l.push(k.target),active_data_links.splice(h,1)):k.target===a&&(f.push(k.source),active_data_links.splice(h,1))}h=$.inArray(a,active_data_nodes);active_data_nodes[h].isActive=!1;for(var k=f.length,p=l.length,m=active_data_nodes.length+b-1,q=2*Math.PI/m,i=m-1;i>h;--i)active_data_nodes[i]=active_data_nodes[i-b+1];
for(i=h;i<h+b;++i){var n=c[i-h];calculateArcPositions(n,d,e,i-h);n.color=a.color;n.isActive=!0;active_data_nodes[i]=n;for(var j=0;j<k;++j){var g=f[j],g=g.key+"-"+n.key,g=node_link_map[g];void 0!==g&&active_data_links.push(g)}for(j=0;j<p;++j)g=l[j],g=n.key+"-"+g.key,g=node_link_map[g],void 0!==g&&active_data_links.push(g)}for(i=0;i<b;++i)for(j=i+1;j<b;++j)g=c[i].key+"-"+c[j].key,g=node_link_map[g],void 0!==g&&active_data_links.push(g),g=c[j].key+"-"+c[i].key,g=node_link_map[g],void 0!==g&&active_data_links.push(g);
updateCircularLayout(m,q)}}function updateCircularLayout(a,c){exitCircularNodes();exitCircularLinks();enterCircularNodes();enterCircularLinks();for(var b=0;b<a;++b)calculateArcPositions(active_data_nodes[b],0,c,b);updateCircularNodes();updateCircularLinks();updateCircularTexts()}
function nodeClick(a){if(d3.event.shiftKey)enable_piwik&&piwikTracker.trackPageView("Combine node in circular view"),enable_owa&&OWATracker.trackAction("Viz","Combine circular node",a.name),combineNodes(a);else{enable_piwik&&piwikTracker.trackPageView("Expand node in circular view");enable_owa&&OWATracker.trackAction("Viz","Expand circular node",a.name);for(var c=[],b=a.children,d=b.length,e=0;e<d;++e)c.push(node_map[b[e]]);expandRegion(a,c,svg_circular)}}
function nodeMouseOver(a,c){current_mode!==mode.search&&(c.selectAll(".circular.node").classed("nofocus",function(b){var b=b.key,c=a.key,e=node_in_neighbor_map[c],f=node_out_neighbor_map[c];return b!==c&&0>$.inArray(b,e)&&0>$.inArray(b,f)}),c.selectAll(".circular.link").classed("nofocus",function(b){return b.source.key!==a.key&&b.target.key!==a.key}),c.selectAll(".circular.text").classed("visible",function(b){var b=b.key,c=a.key,e=node_in_neighbor_map[c],f=node_out_neighbor_map[c];return b===c||0<=
$.inArray(b,e)||0<=$.inArray(b,f)}))}function nodeMouseOut(a,c){current_mode!==mode.search&&(c.selectAll(".circular.node").classed("nofocus",!1),c.selectAll(".circular.link").classed("nofocus",!1),updateCircularTexts())}function linkClick(a){enable_piwik&&piwikTracker.trackPageView("Click link in circular view");enable_owa&&OWATracker.trackAction("Viz","Click circular link",a.source.name+"-"+a.target.name);displayConnectionInfo(a)}
function linkMouseOver(a,c){c.selectAll(".circular.node").classed("nofocus",function(b){return b.key!==a.source.key&&b.key!==a.target.key});c.selectAll(".circular.link").classed("nofocus",function(b){return b.key!==a.key});c.selectAll(".circular.text").classed("visible",function(b){return b.key===a.source.key||b.key===a.target.key})}
function linkMouseOut(a,c){current_mode!==mode.search&&(c.selectAll(".circular.node").classed("nofocus",!1),c.selectAll(".circular.link").classed("nofocus",!1),updateCircularTexts())}function forceNodeClick(a){enable_piwik&&piwikTracker.trackPageView("Click link in nodelink view");enable_owa&&OWATracker.trackAction("Viz","Click force node",a.name);console.log(a)}
function forceNodeMouseOver(a){current_mode!==mode.search&&(svg_force.selectAll(".nodelink.node").classed("nofocus",function(c){var c=c.key,b=a.key,d=node_in_neighbor_map[b],e=node_out_neighbor_map[b];return c!==b&&0>$.inArray(c,d)&&0>$.inArray(c,e)}),svg_force.selectAll(".nodelink.link").classed("nofocus",function(c){return c.source.key!==a.key&&c.target.key!==a.key}),svg_force.selectAll(".nodelink.text").classed("visible",function(c){var c=c.key,b=a.key,d=node_in_neighbor_map[b],e=node_out_neighbor_map[b];
return c===b||0<=$.inArray(c,d)||0<=$.inArray(c,e)}))}function forceNodeMouseOut(){current_mode!==mode.search&&(svg_force.selectAll(".circular.node").classed("nofocus",!1),svg_force.selectAll(".circular.link").classed("nofocus",!1),svg_force.selectAll(".nodelink.text").classed("visible",!0))}
function forceLinkClick(a){enable_piwik&&piwikTracker.trackPageView("Click link in nodelink view");enable_owa&&OWATracker.trackAction("Viz","Click force link",a.source.name+"-"+a.target.name);displayConnectionInfo(a)}
function forceLinkMouseOver(a){svg_force.selectAll(".nodelink.node").classed("nofocus",function(c){return c.key!==a.source.key&&c.key!==a.target.key});svg_force.selectAll(".nodelink.link").classed("nofocus",function(c){return c.key!==a.key});svg_force.selectAll(".nodelink.text").classed("visible",function(c){return c.key===a.source.key||c.key===a.target.key})}
function forceLinkMouseOut(){current_mode!==mode.search&&(svg_force.selectAll(".nodelink.node").classed("nofocus",!1),svg_force.selectAll(".nodelink.link").classed("nofocus",!1),svg_force.selectAll(".nodelink.text").classed("visible",!0))}
function enterCircularNodes(){svg_circular.selectAll(".circular.node").data(active_data_nodes,function(a){return a.key}).enter().append("svg:path").style("fill",function(a){return a.color}).style("stroke","gray").attr("d",arcs).attr("class","circular node").attr("id",function(a){return"circ-node-"+a.key}).on("click",nodeClick).on("mouseover",function(a){nodeMouseOver(a,svg_circular)}).on("mouseout",function(a){nodeMouseOut(a,svg_circular)});svg_circular.selectAll(".circular.text").data(active_data_nodes,
function(a){return a.key}).enter().append("svg:text").attr("x",function(a){return a.circ.x}).attr("y",function(a){return a.circ.y}).attr("class","circular text").attr("id",function(a){return"text-"+a.key}).text(function(a){return a.name})}
function enterCircularLinks(){svg_circular.selectAll(".circular.link").data(active_data_links,function(a){return a.key}).enter().append("svg:path").attr("d",function(a){return curves([{x:a.source.circ.x,y:a.source.circ.y},{x:0,y:0},{x:a.target.circ.x,y:a.target.circ.y}])}).attr("class","circular link").attr("id",function(a){return"circ-link-"+a.key}).on("mouseover",function(a){linkMouseOver(a,svg_circular)}).on("mouseout",function(a){linkMouseOut(a,svg_circular)}).on("click",linkClick)}
function exitCircularNodes(){svg_circular.selectAll(".circular.node").data(active_data_nodes,function(a){return a.key}).exit().remove();svg_circular.selectAll(".circular.text").data(active_data_nodes,function(a){return a.key}).exit().remove()}function exitCircularLinks(){svg_circular.selectAll(".circular.link").data(active_data_links,function(a){return a.key}).exit().remove()}
function updateCircularNodes(){svg_circular.selectAll(".circular.node").data(active_data_nodes,function(a){return a.key}).transition().duration(1E3).attr("d",arcs);svg_circular.selectAll(".circular.text").data(active_data_nodes,function(a){return a.key}).transition().duration(1E3).attr("x",function(a){return a.circ.x}).attr("y",function(a){return a.circ.y})}
function updateCircularLinks(){svg_circular.selectAll(".circular.link").data(active_data_links,function(a){return a.key}).transition().duration(1E3).attr("d",function(a){return curves([{x:a.source.circ.x,y:a.source.circ.y},{x:0,y:0},{x:a.target.circ.x,y:a.target.circ.y}])})}function updateCircularTexts(){svg_circular.selectAll(".circular.text").classed("visible",function(a){a=a.circ;return a.end_angle-a.start_angle>Math.PI/12})}
function updateForceLayout(){var a=0,c={};active_data_nodes_force.forEach(function(b){c[b.group]?c[b.group][1]+=1:(++a,c[b.group]=[a,1])});selected_source.fixed=!0;selected_target.fixed=!0;selected_source.x=200;selected_source.y=400;selected_target.x=600;selected_target.y=400;force=d3.layout.force().nodes(active_data_nodes_force).links(active_data_links_force).size([vis_width,vis_height]).linkDistance(function(a){var b=c[a.source.group],d=c[a.target.group];return 30*Math.max(a.source.group!=a.target.group?
b[1]:2/b[1],a.source.group!=a.target.group?d[1]:2/d[1])+20}).linkStrength(1).charge(-6E3).friction(0.5).start();svg_force.selectAll(".link").remove();svg_force.selectAll(".node").remove();svg_force.selectAll(".text").remove();var b=svg_force.selectAll(".nodelink.link").data(active_data_links_force,function(a){return a.key}).enter().append("svg:line").attr("class","nodelink link").style("stroke-width",3).on("click",forceLinkClick).on("mouseover",forceLinkMouseOver).on("mouseout",forceLinkMouseOut),
d=svg_force.selectAll(".nodelink.node").data(active_data_nodes_force,function(a){return a.key}).enter().append("svg:circle").attr("class","nodelink node").attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("r",function(a){return a===selected_source||a===selected_target?20:10}).style("fill",function(a){return a.color}).on("click",forceNodeClick).on("mouseover",forceNodeMouseOver).on("mouseout",forceNodeMouseOut).call(force.drag),e=svg_force.append("svg:g").selectAll("g").data(force.nodes()).enter().append("g").append("svg:text").attr("x",
8).attr("y",".31em").attr("class","nodelink text visible").text(function(a){return a.name});force.on("tick",function(){b.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});d.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});e.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})})}
function highlightNode(a,c,b,d,e){void 0!==a&&(e.selectAll(".circular.node").classed(c,function(b){return b.key===a.key}),d&&e.select("#text-"+a.key).classed("visible",b))}function expandNode(){}function expandLink(){}
function arcTween(a){var c=d3.interpolate({start_angle:a.circ.old_start_angle,end_angle:a.circ.old_end_angle},a);return function(b){b=c(b);console.log(b);a.circ.old_start_angle=b.start_angle;a.circ.old_end_angle=b.end_angle;b.circ.start_angle=b.start_angle;b.circ.end_angle=b.end_angle;return arcs(b)}};function appendNodesAsOptions(a){for(var c in a){var b=a[c];$("#sourceSelect").append(new Option(b.name,c,!1,!1));$("#targetSelect").append(new Option(b.name,c,!1,!1))}}function searchButtonClick(){enable_piwik&&piwikTracker.trackPageView("Search:"+selected_source.name+"-"+selected_target.name);enable_owa&&OWATracker.trackAction("UI","Search",selected_source.name+"-"+selected_target.name);console.log(max_hop);var a=calculatePaths(max_hop);populateForceElements(a);updateForceLayout()}
function clearButtonClick(){enable_piwik&&piwikTracker.trackPageView("Click clear button")}
function sourceSearchInput(){enable_piwik&&piwikTracker.trackPageView("Set search source");void 0!=selected_source&&(selected_source.fixed=!1,highlightNode(selected_source,"focus",!1,!0,svg_circular),clearSearchResult());var a=node_map[this.value];selected_source=a;if(!a.isActive){var c=findActiveParent(a),b=findDescAtDepth(c,a.depth);expandRegion(c,b,svg_circular)}highlightNode(a,"focus",!0,!0,svg_circular);enable_owa&&OWATracker.trackAction("UI","Set source",selected_source.name)}
function targetSearchInput(){enable_piwik&&piwikTracker.trackPageView("Set search target");void 0!=selected_target&&(selected_target.fixed=!1,highlightNode(selected_target,"focus",!1,!0,svg_circular),clearSearchResult());var a=node_map[this.value];selected_target=a;if(!a.isActive){var c=findActiveParent(a),b=findDescAtDepth(c,a.depth);expandRegion(c,b,svg_circular)}highlightNode(a,"focus",!0,!0,svg_circular);enable_owa&&OWATracker.trackAction("UI","Set target",selected_target.name)}
function clearSearchResult(){}function setMaxHop(){enable_piwik&&piwikTracker.trackPageView("Set max hop");enable_owa&&OWATracker.trackAction("UI","Set max hop",this.value);max_hop=this.value;document.getElementById("maxHopValue").innerHTML=max_hop}
function displayConnectionInfo(a){d3.selectAll("#conn-info .exp").remove();d3.select("#conn-info #src-name").html("Source: "+a.source.name);d3.select("#conn-info #tgt-name").html("Target: "+a.target.name);var c=a.paper,b=d3.select("#paper-list");b.selectAll("p").remove();b=b.append("p");1>c.length?b.html("This is a meta link. See the derived connections for more information"):b.selectAll("p").data(c).enter().append("p").html(function(a){a=paper_map[a];return'<a href="'+a.url+'" target="_blank">'+
a.title+"</a>"});c=d3.select("#bams-list");c.selectAll("p").remove();b=c.append("p");b.html("Links to BAMS records will be added in future updates");console.log(a);a=a.children;c=d3.select("#sub-con-list");c.selectAll("p").remove();b=c.append("p");1>a.length?b.html("There are no sub-connections for this link."):b.selectAll("p").data(a).enter().append("p").html(function(a){a=link_map[a];return"Source: "+a.source.name+"; Target: "+a.target.name})};function combineNodes(a){if(!(void 0===a.parent||null===a.parent)){a=findActiveSiblings(a);console.log(a);var c=a.length,b=active_data_links.length;for(console.log(active_data_links);b--;)for(var d=active_data_links[b],e=0;e<c;++e){var f=a[e];(d.source===f||d.target===f)&&active_data_links.splice(b,1)}console.log(active_data_links);a=active_data_nodes.length;updateCircularLayout(a,2*Math.PI/a)}}
function findActiveSiblings(a){for(var a=node_map[a.parent].children,c=[],b=a.length,d=0;d<b;++d)c.push(node_map[a[d]]);return c}function findActiveParent(a){for(;void 0!==a&&null!==a&&!a.isActive;)a=node_map[a.parent];return a}function findDescAtDepth(a,c){for(var b=[a];0<b.length&&b[0].depth<c;){for(var d=b[0].children,e=d.length,f=0;f<e;++f)b.push(node_map[d[f]]);b.splice(0,1);console.log(b[0])}return b}
function contains(a,c){for(var b=a.length,d=0;d<b;++d)if(c.key===a[d].key)return d;return-1}function initActiveNodes(){active_data_nodes=[];for(var a in node_map){var c=node_map[a];1===c.depth&&(c.isActive=!0,active_data_nodes.push(c))}}function initActiveLinks(){active_data_links=[];for(var a in link_map){var c=link_map[a];1===c.source.depth&&1===c.target.depth&&active_data_links.push(c)}}
function calculatePaths(a){var c=0,b=[],d=[];b[0]=[selected_source];for(var e=selected_source.depth,f=selected_target.depth,l=Math.min(e,f),e=Math.max(e,f);0<b.length&&b[0].length<=a+2;){f=b[0];b.splice(0,1);var h=f[f.length-1];if(h.key===selected_target.key)d.push(f);else if(!(f.length>=a+2)){for(var h=node_out_neighbor_map[h.key],k=h.length,p=0;p<k;++p){var m=node_map[h[p]];m.depth>=l&&m.depth<=e&&b.push(f.concat(m))}c++;if(5E3<c){enable_owa&&(console.log(selected_source),console.log(selected_target),
OWATracker.trackAction("Warning","Path size limit reached",selected_source.name+"-"+selected_target+"-"+max_hop));console.log("Reached path limit.");break}}}return d}
function populateForceElements(a){var c=a.length;active_data_nodes_force=[];active_data_links_force=[];for(var b=0;b<c;++b)for(var d=a[b],e=d.length-1,f=0;f<e;++f){var l=d[f],h=d[f+1],k=node_link_map[l.key+"-"+h.key];0>$.inArray(k,active_data_links_force)&&active_data_links_force.push(k);0>$.inArray(l,active_data_nodes_force)&&active_data_nodes_force.push(l);0>$.inArray(h,active_data_nodes_force)&&active_data_nodes_force.push(h)}}
function assignColors(){var a=0,c=[],b;for(b in node_map){var d=node_map[b];1===d.depth&&(a+=1,d.group=d.key,c.push(d))}d=[];for(b=0;b<a;++b)d.push(colorPalette[b]);d3.scale.ordinal().domain(d3.range(a)).range(d);for(b=0;b<a;++b)c[b].color=d[b];for(;0<c.length;){var a=c[0],d=a.children,e=d.length;for(b=0;b<e;++b){var f=node_map[d[b]];f.color=a.color;f.group=a.group;c.push(f)}c.splice(0,1)}}
function computeCircularNodesParameters(a){for(var c=a.length,b=2*Math.PI/c,d=0;d<c;++d)calculateArcPositions(a[d],0,b,d)}function calculateArcPositions(a,c,b,d){a.circ.start_angle=c+b*d;a.circ.end_angle=c+b*(d+1);c=b*(d+0.5)+c;b=inner_radius+(outer_radius-inner_radius)/2;a.circ.x=b*Math.cos(Math.PI/2-c);a.circ.y=-b*Math.sin(Math.PI/2-c)}function stash(a){a.circ.old_start_angle=a.circ.start_angle;a.circ.old_end_angle=a.circ.end_angle};
