var node_link_map,link_map,paper_map,node_map,node_in_neighbor_map,node_out_neighbor_map,link_rating_map,record_rating_map,selected_source,selected_target,active_data_nodes,active_data_links,active_data_nodes_force,active_data_links_force,svg_circular,svg_force,arcs,curves,links,force,vis_width=800,vis_height=800,inner_radius=0.32*Math.min(vis_width,vis_height),outer_radius=1.2*inner_radius,directionType={"in":1,out:2,bi:3},colorPalette=[d3.rgb(141,211,199).toString(),d3.rgb(255,255,179).toString(),
d3.rgb(190,186,218).toString(),d3.rgb(251,128,114).toString(),d3.rgb(128,177,211).toString(),d3.rgb(253,180,98).toString(),d3.rgb(179,222,105).toString(),d3.rgb(252,205,229).toString(),d3.rgb(217,217,217).toString(),d3.rgb(188,128,189).toString(),d3.rgb(204,235,197).toString(),d3.rgb(255,237,111).toString()],mutex=3,enable_piwik=!1;d3.json("media/data/test_node.json",function(a){node_map={};node_in_neighbor_map={};node_out_neighbor_map={};for(var b=a.length,c=0;c<b;++c){var d=a[c];d.circ={};node_map[d.key]=d;node_in_neighbor_map[d.key]=[];node_out_neighbor_map[d.key]=[]}mutex-=1});d3.json("media/data/test_paper.json",function(a){paper_map={};for(var b=a.length,c=0;c<b;++c){var d=a[c];paper_map[d.key]=d}mutex-=1});
d3.json("media/data/test_link.json",function(a){link_map={};node_link_map={};for(var b=a.length,c=0;c<b;++c){var d=a[c],e={key:d.key,source:node_map[d.sourceKey],target:node_map[d.targetKey],paper:d.paper};link_map[e.key]=e;node_link_map[e.source.key+"-"+e.target.key]=e;node_in_neighbor_map[d.targetKey].push(d.sourceKey);node_out_neighbor_map[d.sourceKey].push(d.targetKey)}mutex-=1});waitForDataLoading();d3.select("#bt-search").on("click",searchButtonClick);d3.select("#bt-clear").on("click",clearButtonClick);
$("#sourceSelect").change(sourceSearchInput);$("#targetSelect").change(targetSearchInput);
function renderCanvas(){assignColors();initActiveNodes();computeCircularNodesParameters(active_data_nodes);initActiveLinks();arcs=d3.svg.arc().innerRadius(inner_radius).outerRadius(outer_radius).startAngle(function(a){return a.circ.start_angle}).endAngle(function(a){return a.circ.end_angle});curves=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}).interpolate("basis");svg_circular=d3.select("#canvas-circular").append("svg").attr("width",vis_width).attr("height",vis_height).append("g").attr("transform",
"translate("+vis_width/2+","+vis_height/2+")").append("g");svg_force=d3.select("#canvas-force").append("svg").attr("width",vis_width).attr("height",vis_height).append("g");enterCircularNodes();enterCircularLinks()}function setupUIElements(){appendNodesAsOptions(node_map);$(".chzn-select").chosen({allow_single_deselect:!0})}function waitForDataLoading(){0<mutex?setTimeout(function(){waitForDataLoading()},1E3):(renderCanvas(),setupUIElements())};function expandRegion(a,b){var c=b.length;if(!(1>c)){for(var d=a.circ.start_angle,e=(a.circ.end_angle-d)/c,f=[],j=[],g=active_data_links.length;g--;){var k=active_data_links[g];k.source===a?(j.push(k.target),active_data_links.splice(g,1)):k.target===a&&(f.push(k.source),active_data_links.splice(g,1))}g=$.inArray(a,active_data_nodes);active_data_nodes[g].isActive=!1;for(var k=f.length,p=j.length,n=active_data_nodes.length+c-1,q=2*Math.PI/n,h=n-1;h>g;--h)active_data_nodes[h]=active_data_nodes[h-c+1];
for(h=g;h<g+c;++h){var l=b[h-g];calculateArcPositions(l,d,e,h-g);l.color=a.color;l.isActive=!0;active_data_nodes[h]=l;for(var m=0;m<k;++m){var i=f[m],i=i.key+"-"+l.key,i=node_link_map[i];void 0!==i&&active_data_links.push(i)}for(m=0;m<p;++m)i=j[m],i=l.key+"-"+i.key,i=node_link_map[i],void 0!==i&&active_data_links.push(i)}enterCircularNodes();enterCircularLinks();exitCircularNodes();exitCircularLinks();for(h=0;h<n;++h)l=active_data_nodes[h],calculateArcPositions(l,0,q,h);updateCircularNodes();updateCircularLinks()}}
function nodeClick(a){for(var b=[],c=a.children,d=c.length,e=0;e<d;++e)b.push(node_map[c[e]]);expandRegion(a,b,svg_circular)}
function linkClick(a){d3.select("#self-content #src-name").html("Source: "+a.source.name);d3.select("#self-content #tgt-name").html("Target: "+a.target.name);var a=a.paper,b=d3.select("#self-record-paper");b.selectAll("p").remove();b=b.append("p");1>a.length?b.html("This is a meta link. See the derived connections for more information"):b.selectAll("p").data(a).enter().append("p").html(function(a){a=paper_map[a];return'<a href="'+a.url+'">'+a.title+"</a>"})}
function linkMouseOver(a,b){b.select("#circ-link-"+a.key).classed("focus",!0);b.select("#circ-node-"+a.source.key).classed("focus",!0);b.select("#circ-node-"+a.target.key).classed("focus",!0)}function linkMouseOut(a,b){b.select("#circ-link-"+a.key).classed("focus",!1);b.select("#circ-node-"+a.source.key).classed("focus",!1);b.select("#circ-node-"+a.target.key).classed("focus",!1)}
function enterCircularNodes(){svg_circular.selectAll(".circular.node").data(active_data_nodes,function(a){return a.key}).enter().append("svg:path").style("fill",function(a){return a.color}).style("stroke","gray").attr("d",arcs).attr("class","circular node").attr("id",function(a){return"circ-node-"+a.key}).on("click",nodeClick);svg_circular.selectAll(".circular.text").data(active_data_nodes,function(a){return a.key}).enter().append("svg:text").attr("x",function(a){return a.circ.x}).attr("y",function(a){return a.circ.y}).attr("class",
"circular text visible").text(function(a){return a.name})}
function enterCircularLinks(){svg_circular.selectAll(".circular.link").data(active_data_links,function(a){return a.key}).enter().append("svg:path").attr("d",function(a){return curves([{x:a.source.circ.x,y:a.source.circ.y},{x:0,y:0},{x:a.target.circ.x,y:a.target.circ.y}])}).attr("class","circular link").attr("id",function(a){return"circ-link-"+a.key}).on("mouseover",function(a){linkMouseOver(a,svg_circular)}).on("mouseout",function(a){linkMouseOut(a,svg_circular)}).on("click",linkClick)}
function exitCircularNodes(){svg_circular.selectAll(".circular.node").data(active_data_nodes,function(a){return a.key}).exit().remove();svg_circular.selectAll(".circular.text").data(active_data_nodes,function(a){return a.key}).exit().remove()}function exitCircularLinks(){svg_circular.selectAll(".circular.link").data(active_data_links,function(a){return a.key}).exit().remove()}
function updateCircularNodes(){svg_circular.selectAll(".circular.node").data(active_data_nodes,function(a){return a.key}).transition().duration(1E3).attr("d",arcs);svg_circular.selectAll(".circular.text").data(active_data_nodes,function(a){return a.key}).transition().duration(1E3).attr("x",function(a){return a.circ.x}).attr("y",function(a){return a.circ.y})}
function updateCircularLinks(){svg_circular.selectAll(".circular.link").data(active_data_links,function(a){return a.key}).transition().duration(1E3).attr("d",function(a){return curves([{x:a.source.circ.x,y:a.source.circ.y},{x:0,y:0},{x:a.target.circ.x,y:a.target.circ.y}])})}
function updateForceLayout(){var a=0,b={};active_data_nodes_force.forEach(function(c){b[c.group]?b[c.group][1]+=1:(++a,b[c.group]=[a,1])});force=d3.layout.force().nodes(active_data_nodes_force).links(active_data_links_force).size([vis_width,vis_height]).linkDistance(function(a){var c=b[a.source.group],d=b[a.target.group];return 30*Math.max(a.source.group!=a.target.group?c[1]:2/c[1],a.source.group!=a.target.group?d[1]:2/d[1])+20}).linkStrength(1).charge(-600).friction(0.5).start();var c=svg_force.selectAll("nodelink.links").data(active_data_links_force).enter().append("svg:line").attr("class",
"link").style("stroke-width",3),d=svg_force.selectAll("nodelink.nodes").data(active_data_nodes_force).enter().append("svg:circle").attr("class","node").attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("r",5).style("fill",function(a){return a.color}).call(force.drag);force.on("tick",function(){c.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});d.attr("cx",
function(a){return a.x}).attr("cy",function(a){return a.y})})}function highlightNode(a,b,c,d,e){void 0!==a&&(e.select("#circ-node-"+a.key).classed(b,c),d&&e.select("#text-"+a.key).classed("selected",c))}function expandNode(){}function expandLink(){}
function arcTween(a){var b=d3.interpolate({start_angle:a.circ.old_start_angle,end_angle:a.circ.old_end_angle},a);return function(c){c=b(c);console.log(c);a.circ.old_start_angle=c.start_angle;a.circ.old_end_angle=c.end_angle;c.circ.start_angle=c.start_angle;c.circ.end_angle=c.end_angle;return arcs(c)}};function appendNodesAsOptions(a){for(var b in a){var c=a[b];$("#sourceSelect").append(new Option(c.name,b,!1,!1));$("#targetSelect").append(new Option(c.name,b,!1,!1))}}function searchButtonClick(){var a=calculatePaths(1);populateForceElements(a);updateForceLayout()}function clearButtonClick(){}
function sourceSearchInput(){enable_piwik&&piwikTracker.trackPageView("Set source for search");void 0!=selected_source&&(highlightNode(selected_source,"focus",!1,!0,svg_circular),clearSearchResult());var a=node_map[this.value];selected_source=a;if(!a.isActive){var b=findActiveParent(a),c=findDescAtDepth(b,a.depth);expandRegion(b,c,svg_circular)}highlightNode(a,"focus",!0,!0,svg_circular)}
function targetSearchInput(){enable_piwik&&piwikTracker.trackPageView("Set source for search");void 0!=selected_target&&(highlightNode(selected_target,"focus",!1,!0,svg_circular),clearSearchResult());var a=node_map[this.value];selected_target=a;if(!a.isActive){var b=findActiveParent(a),c=findDescAtDepth(b,a.depth);expandRegion(b,c,svg_circular)}highlightNode(a,"focus",!0,!0,svg_circular)}function clearSearchResult(){};function findActiveParent(a){for(;void 0!==a&&null!==a&&!a.isActive;)a=node_map[a.parent];return a}function findDescAtDepth(a,b){for(var c=[a];c[0].depth<b;){for(var d=c[0].children,e=d.length,f=0;f<e;++f)c.push(node_map[d[f]]);c.splice(0,1)}return c}function contains(a,b){for(var c=a.length,d=0;d<c;++d)if(b.key===a[d].key)return d;return-1}function initActiveNodes(){active_data_nodes=[];for(var a in node_map){var b=node_map[a];1===b.depth&&(b.isActive=!0,active_data_nodes.push(b))}}
function initActiveLinks(){active_data_links=[];for(var a in link_map){var b=link_map[a];1===b.source.depth&&1===b.target.depth&&active_data_links.push(b)}}function calculatePaths(a){var b=[],c=[];for(b[0]=[selected_source];0<b.length&&b[0].length<=a+2;){var d=b[0];b.splice(0,1);var e=d[d.length-1];if(e.key===selected_target.key)c.push(d);else for(var e=node_out_neighbor_map[e.key],f=e.length,j=0;j<f;++j)b.push(d.concat(node_map[e[j]]))}return c}
function populateForceElements(a){var b=a.length;active_data_nodes_force=[];active_data_links_force=[];for(var c=0;c<b;++c)for(var d=a[c],e=d.length-1,f=0;f<e-1;++f){var j=d[f],g=d[f+1],k=node_link_map[j.key+"-"+g.key];0>$.inArray(k,active_data_links_force)&&active_data_links_force.push(k);0>$.inArray(j,active_data_nodes_force)&&active_data_nodes_force.push(j);0>$.inArray(g,active_data_nodes_force)&&active_data_nodes_force.push(g)}console.log(active_data_nodes_force);console.log(active_data_links_force)}
function assignColors(){var a=0,b=[],c;for(c in node_map){var d=node_map[c];1===d.depth&&(a+=1,b.push(d))}c=[];for(d=0;d<a;++d)c.push(colorPalette[d]);d3.scale.ordinal().domain(d3.range(a)).range(c);for(d=0;d<a;++d){b[d].color=c[d];for(var e=0;e<b[d].children.length;++e){var f=node_map[b[d].children[e]];f.color=c[d];f.group=b[d].key}}}function computeCircularNodesParameters(a){for(var b=a.length,c=2*Math.PI/b,d=0;d<b;++d)calculateArcPositions(a[d],0,c,d)}
function calculateArcPositions(a,b,c,d){a.circ.start_angle=b+c*d;a.circ.end_angle=b+c*(d+1);b=c*(d+0.5)+b;c=inner_radius+(outer_radius-inner_radius)/2;a.circ.x=c*Math.cos(Math.PI/2-b);a.circ.y=-c*Math.sin(Math.PI/2-b)}function stash(a){a.circ.old_start_angle=a.circ.start_angle;a.circ.old_end_angle=a.circ.end_angle};
