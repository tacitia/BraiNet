var node_link_map,link_map,paper_map,node_map,node_in_neighbor_map,node_out_neighbor_map,link_rating_map,record_rating_map,selected_source,selected_target,active_data_nodes,active_data_links,active_data_nodes_force,active_data_links_force,svg_circular,svg_force,arcs,curves,linkGenerator,links,force,vis_width=800,vis_height=800,inner_radius=0.32*Math.min(vis_width,vis_height),outer_radius=1.2*inner_radius,directionType={"in":1,out:2,bi:3},colorPalette=[d3.rgb(141,211,199).toString(),d3.rgb(255,255,
179).toString(),d3.rgb(190,186,218).toString(),d3.rgb(251,128,114).toString(),d3.rgb(128,177,211).toString(),d3.rgb(253,180,98).toString(),d3.rgb(179,222,105).toString(),d3.rgb(252,205,229).toString(),d3.rgb(217,217,217).toString(),d3.rgb(188,128,189).toString(),d3.rgb(204,235,197).toString(),d3.rgb(255,237,111).toString()],mutex=2,enable_piwik=!1;d3.json("media/data/test_node.json",function(c){node_map={};node_in_neighbor_map={};node_out_neighbor_map={};for(var a=c.length,d=0;d<a;++d){var b=c[d];b.circ={};node_map[b.key]=b;node_in_neighbor_map[b.key]=[];node_out_neighbor_map[b.key]=[]}mutex-=1});
d3.json("media/data/test_link.json",function(c){link_map={};node_link_map={};for(var a=c.length,d=0;d<a;++d){var b=c[d],f={key:b.key,source:node_map[b.sourceKey],target:node_map[b.targetKey]};link_map[f.key]=f;node_link_map[f.source.key+"-"+f.target.key]=f;node_in_neighbor_map[b.targetKey].push(b.sourceKey);node_out_neighbor_map[b.sourceKey].push(b.targetKey)}mutex-=1});waitForDataLoading();d3.select("#bt-search").on("click",searchButtonClick);d3.select("#bt-clear").on("click",clearButtonClick);$("#sourceSelect").change(sourceSearchInput);
$("#targetSelect").change(targetSearchInput);
function renderCanvas(){assignColors();initActiveNodes();computeCircularNodesParameters(active_data_nodes);initActiveLinks();arcs=d3.svg.arc().innerRadius(inner_radius).outerRadius(outer_radius).startAngle(function(a){return a.circ.startAngle}).endAngle(function(a){return a.circ.endAngle});curves=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}).interpolate("basis");var c=0,a={};active_data_nodes_force.forEach(function(b){a[b.group]?a[b.group][1]+=1:(++c,a[b.group]=[c,1])});force=
d3.layout.force().nodes(active_data_nodes_force).links(active_data_links_force).size([vis_width,vis_height]).linkDistance(function(b){var c=a[b.source.group],d=a[b.target.group];return 30*Math.max(b.source.group!=b.target.group?c[1]:2/c[1],b.source.group!=b.target.group?d[1]:2/d[1])+20}).linkStrength(1).charge(-600).friction(0.5).start();svg_circular=d3.select("#canvas-circular").append("svg").attr("width",vis_width).attr("height",vis_height).append("g").attr("transform","translate("+vis_width/2+
","+vis_height/2+")").append("g");svg_force=d3.select("#canvas-force").append("svg").attr("width",vis_width).attr("height",vis_height).append("g");enterCircularNodes(svg_circular);enterCircularLinks(svg_circular);var d=svg_force.selectAll("nodelink.links").data(active_data_links_force).enter().append("svg:line").attr("class","links").style("stroke-width",3),b=svg_force.selectAll("nodelink.nodes").data(active_data_nodes_force).enter().append("svg:circle").attr("class","node").attr("cx",function(a){return a.x}).attr("cy",
function(a){return a.y}).attr("r",5).style("fill",function(a){return a.color}).call(force.drag);force.on("tick",function(c){var i=8*c.alpha;active_data_nodes_force.forEach(function(b){b.x+=a[b.group][0]*i;b.y+=a[b.group][0]*-i});d.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});b.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}
function setupUIElements(){appendNodesAsOptions(node_map);$(".chzn-select").chosen({allow_single_deselect:!0})}function waitForDataLoading(){0<mutex?setTimeout(function(){waitForDataLoading()},1E3):(renderCanvas(),setupUIElements())};function expandRegion(c,a){var d=c.children,b=d.length;if(!(1>b)){for(var f=c.circ.startAngle,i=(c.circ.endAngle-f)/b,m=[],n=[],l=[],p=active_data_links.length,g=0;g<p;++g){var h=active_data_links[g];h.source===c&&(n.push(h.target),l.push(h.source.key+"-"+h.target.key));h.target===c&&(m.push(h.source),l.push(h.source.key+"-"+h.target.key))}for(var h=m.length,q=n.length,p=l.length,g=0;g<b;++g){var k=node_map[d[g]];calculateArcPositions(k,f,i,g);k.color=c.color;active_data_nodes.push(k);for(var j=0;j<
h;++j){var e=m[j],e=e.key+"-"+k.key,e=node_link_map[e];void 0!==e&&active_data_links.push(e)}for(j=0;j<q;++j)e=n[j],e=k.key+"-"+e.key,e=node_link_map[e],void 0!==e&&active_data_links.push(e)}enterCircularNodes(a);enterCircularLinks(a);d=$.inArray(c,active_data_nodes);active_data_nodes.splice(d,1);for(g=0;g<p;++g)e=l[g],e=node_link_map[e],d=$.inArray(e,active_data_links),active_data_links.splice(d,1);a.selectAll(".circular.nodes").data(active_data_nodes,function(a){return a.key}).exit().remove();a.selectAll("text").data(active_data_nodes,
function(a){return a.key}).exit().remove();a.selectAll(".circular.links").data(active_data_links,function(a){return a.key}).exit().remove()}}function linkClick(){}
function enterCircularNodes(c){c.selectAll(".circular.nodes").data(active_data_nodes,function(a){return a.key}).enter().append("svg:path").style("fill",function(a){return a.color}).style("stroke","gray").attr("d",arcs).attr("class","circular nodes").on("click",function(a){expandRegion(a,c)});c.selectAll("text").data(active_data_nodes,function(a){return a.key}).enter().append("text").attr("x",function(a){return a.circ.x}).attr("y",function(a){return a.circ.y}).attr("class","text visible").text(function(a){return a.name})}
function enterCircularLinks(c){c.selectAll(".circular.links").data(active_data_links,function(a){return a.key}).enter().append("svg:path").attr("d",function(a){return curves([{x:a.source.circ.x,y:a.source.circ.y},{x:0,y:0},{x:a.target.circ.x,y:a.target.circ.y}])}).attr("stroke","black").attr("fill","none").attr("class","circular links").on("click",linkClick)}function highlightNode(c,a,d,b,f){void 0!==c&&(f.select("#arc-"+c.key).classed(a,d),b&&f.select("#text-"+c.key).classed("selected",d))}
function expandNode(){}function expandLink(){};function appendNodesAsOptions(c){for(var a in c){var d=c[a];$("#sourceSelect").append(new Option(d.name,d.name,!1,!1));$("#targetSelect").append(new Option(d.name,d.name,!1,!1))}}function searchButtonClick(){}function clearButtonClick(){}function sourceSearchInput(){enable_piwik&&piwikTracker.trackPageView("Set source for search")}function targetSearchInput(){}function clearSearchResult(){};function contains(c,a){for(var d=c.length,b=0;b<d;++b)if(a.key===c[b].key)return b;return-1}function initActiveNodes(){active_data_nodes=[];active_data_nodes_force=[];for(var c in node_map){var a=node_map[c];1===a.depth&&active_data_nodes.push(a);var d=0,d=d+node_in_neighbor_map[c].length,d=d+node_out_neighbor_map[c].length;2===a.depth&&0<d&&active_data_nodes_force.push(a)}active_data_nodes_force[0].isSource=!0;active_data_nodes_force[1].isTarget=!0}
function initActiveLinks(){active_data_links=[];active_data_links_force=[];for(var c in link_map){var a=link_map[c];1===a.source.depth&&1===a.target.depth&&active_data_links.push(a);2===a.source.depth&&2===a.target.depth&&active_data_links_force.push(a)}}
function assignColors(){var c=0,a=[],d;for(d in node_map){var b=node_map[d];1===b.depth&&(c+=1,a.push(b))}d=[];for(b=0;b<c;++b)d.push(colorPalette[b]);d3.scale.ordinal().domain(d3.range(c)).range(d);for(b=0;b<c;++b){a[b].color=d[b];for(var f=0;f<a[b].children.length;++f){var i=node_map[a[b].children[f]];i.color=d[b];i.group=a[b].key}}}function computeCircularNodesParameters(c){for(var a=c.length,d=2*Math.PI/a,b=0;b<a;++b)calculateArcPositions(c[b],0,d,b)}
function calculateArcPositions(c,a,d,b){c.circ.startAngle=a+d*b;c.circ.endAngle=a+d*(b+1);a=d*(b+0.5)+a;d=inner_radius+(outer_radius-inner_radius)/2;c.circ.x=d*Math.cos(Math.PI/2-a);c.circ.y=-d*Math.sin(Math.PI/2-a)};
